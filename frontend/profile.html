<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings - Kerala Farmer Advisory</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #047857;
            --primary-light: #34d399;
            --secondary: #6366f1;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #ffffff;
            --bg-dark: #0f172a;
            --card-light: #ffffff;
            --card-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
            --border-light: #e2e8f0;
            --border-dark: #475569;
            --secondary-light: #f8fafc;
            --secondary-dark: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-light);
            color: var(--text-light);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        body.dark {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        /* Header */
        .header {
            background: var(--card-light);
            border-bottom: 1px solid var(--border-light);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        body.dark .header {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-primary {
            background: var(--primary);
            border: 1px solid var(--primary);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            color: white;
            text-decoration: none;
            transform: translateY(-1px);
        }

        .theme-toggle {
            background: var(--secondary-light);
            border: none;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        body.dark .theme-toggle {
            background: var(--secondary-dark);
            color: var(--text-dark);
        }

        /* Main Container */
        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        /* Profile Sidebar */
        .profile-sidebar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .profile-card {
            background: var(--card-light);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        body.dark .profile-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .profile-avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--success));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            font-weight: 700;
            object-fit: cover;
            border: 4px solid var(--card-light);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark .profile-avatar {
            border-color: var(--card-dark);
        }

        .avatar-upload {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 35px;
            height: 35px;
            background: var(--primary);
            border: 2px solid var(--card-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-upload:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        body.dark .profile-name {
            color: var(--text-dark);
        }

        .profile-role {
            color: var(--text-light);
            opacity: 0.7;
            margin-bottom: 1rem;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-box {
            text-align: center;
            padding: 1rem;
            background: var(--secondary-light);
            border-radius: 12px;
        }

        body.dark .stat-box {
            background: var(--secondary-dark);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-light);
            opacity: 0.7;
        }

        /* Language Selector */
        .language-card {
            background: var(--card-light);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        body.dark .language-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .language-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        body.dark .language-title {
            color: var(--text-dark);
        }

        .language-options {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            background: var(--secondary-light);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        body.dark .language-option {
            background: var(--secondary-dark);
        }

        .language-option:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: white;
        }

        .language-option.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .language-flag {
            font-size: 1.5rem;
        }

        .language-info {
            flex: 1;
        }

        .language-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .language-native {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .settings-card {
            background: var(--card-light);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        body.dark .settings-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .settings-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        body.dark .settings-title {
            color: var(--text-dark);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        body.dark .form-label {
            color: var(--text-dark);
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            background: var(--bg-light);
            color: var(--text-light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        body.dark .form-input {
            background: var(--secondary-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .save-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .save-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .save-btn:disabled {
            background: var(--border-light);
            cursor: not-allowed;
            transform: none;
        }

        /* Delete Account Section */
        .danger-zone {
            border: 2px solid var(--danger);
            border-radius: 12px;
            padding: 1.5rem;
            background: rgba(239, 68, 68, 0.05);
        }

        .danger-title {
            color: var(--danger);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .danger-description {
            color: var(--text-light);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .danger-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .danger-btn:hover {
            background: #dc2626;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--danger);
            color: white;
        }

        .notification.info {
            background: var(--accent);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading states */
        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1.5rem;
            }

            .header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1.25rem;
                text-align: center;
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .profile-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .profile-stats {
                grid-template-columns: 1fr;
            }

            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }

            .save-btn {
                width: 100%;
                justify-content: center;
            }

            .header-actions {
                flex-direction: column;
            }

            .btn-primary {
                width: 100%;
                justify-content: center;
            }

            .notification {
                width: calc(100% - 40px);
                min-width: auto;
            }
        }
    </style>
    <script src="config.js"></script>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <div class="header-icon">
                    <i class="fas fa-user-cog"></i>
                </div>
                <h1 data-translate>Profile Settings</h1>
            </div>
            <div class="header-actions">
                <a href="dashboard.html" class="btn-primary">
                    <i class="fas fa-arrow-left"></i>
                    <span data-translate>Dashboard</span>
                </a>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Profile Sidebar -->
        <div class="profile-sidebar">
            <!-- Profile Card -->
            <div class="profile-card">
                <div class="profile-avatar-container">
                    <img class="profile-avatar" id="profileAvatar" src="" alt="Profile" style="display: none;">
                    <div class="profile-avatar" id="profileAvatarText">F</div>
                    <div class="avatar-upload" onclick="selectProfileImage()">
                        <i class="fas fa-camera"></i>
                    </div>
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;"
                        onchange="handleAvatarUpload(event)">
                </div>
                <h2 class="profile-name" id="profileDisplayName">Loading...</h2>
                <p class="profile-role" data-translate>Kerala Farmer</p>

                <div class="profile-stats">
                    <div class="stat-box">
                        <div class="stat-number" id="userPosts">0</div>
                        <div class="stat-label" data-translate>Posts</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="userComments">0</div>
                        <div class="stat-label" data-translate>Comments</div>
                    </div>
                </div>
            </div>

            <!-- Language Card -->
            <div class="language-card">
                <h3 class="language-title">
                    <i class="fas fa-globe"></i>
                    <span data-translate>Language</span>
                </h3>
                <div class="language-options">
                    <div class="language-option active" onclick="changeLanguage('en')" data-lang="en">
                        <span class="language-flag">üá¨üáß</span>
                        <div class="language-info">
                            <div class="language-name">English</div>
                            <div class="language-native">English</div>
                        </div>
                    </div>
                    <div class="language-option" onclick="changeLanguage('ml')" data-lang="ml">
                        <span class="language-flag">üáÆüá≥</span>
                        <div class="language-info">
                            <div class="language-name">Malayalam</div>
                            <div class="language-native">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</div>
                        </div>
                    </div>
                    <div class="language-option" onclick="changeLanguage('hi')" data-lang="hi">
                        <span class="language-flag">üáÆüá≥</span>
                        <div class="language-info">
                            <div class="language-name">Hindi</div>
                            <div class="language-native">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Personal Information -->
            <div class="settings-card">
                <h2 class="settings-title">
                    <i class="fas fa-user"></i>
                    <span data-translate>Personal Information</span>
                </h2>

                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-translate>Full Name</label>
                            <input type="text" class="form-input" id="fullName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-translate>Email Address</label>
                            <input type="email" class="form-input" id="email" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-translate>Phone Number</label>
                            <input type="tel" class="form-input" id="phone">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-translate>Farm Size (acres)</label>
                            <input type="number" class="form-input" id="farmSize" step="0.1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-translate>Location</label>
                        <input type="text" class="form-input" id="location" placeholder="City, District, State">
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-translate>About Your Farm</label>
                        <textarea class="form-input form-textarea" id="farmDescription"
                            placeholder="Tell us about your farming experience, crops you grow, etc."></textarea>
                    </div>

                    <button type="submit" class="save-btn" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        <span data-translate>Save Changes</span>
                    </button>
                </form>
            </div>


            <!-- Danger Zone -->
            <div class="settings-card">
                <h2 class="settings-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span data-translate>Danger Zone</span>
                </h2>

                <div class="danger-zone">
                    <h3 class="danger-title" data-translate>Delete Account</h3>
                    <p class="danger-description" data-translate>
                        Once you delete your account, there is no going back. Please be certain.
                        All your posts, comments, and data will be permanently removed.
                    </p>
                    <button class="danger-btn" onclick="confirmDeleteAccount()">
                        <i class="fas fa-trash-alt"></i>
                        <span data-translate>Delete Account</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function selectProfileImage() {
            document.getElementById('avatarInput').click();
        }


        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('profileAvatar').src = e.target.result;
                    document.getElementById('profileAvatar').style.display = 'block';
                    document.getElementById('profileAvatarText').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }
    </script>
    <!-- Google Translate Script -->
    <script type="text/javascript"
        src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script type="text/javascript">
        // Theme management
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let currentLanguage = localStorage.getItem('selectedLanguage') || 'en';
        let userProfile = {};
        let googleTranslateLoaded = false;

        function initializeTheme() {
            if (isDarkMode) {
                document.body.classList.add('dark');
            }

            const themeBtn = document.querySelector('.theme-toggle i');
            if (themeBtn) {
                themeBtn.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', isDarkMode);

            const themeBtn = document.querySelector('.theme-toggle i');
            if (themeBtn) {
                themeBtn.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // ENHANCED: Google Translate initialization with cross-page support
        function googleTranslateElementInit() {
            if (window.google && window.google.translate) {
                new google.translate.TranslateElement({
                    pageLanguage: 'en',
                    includedLanguages: 'en,ml,hi',
                    layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                    autoDisplay: false,
                    multilanguagePage: true
                }, 'google_translate_element');

                googleTranslateLoaded = true;
                console.log('Google Translate loaded successfully');

                // Apply saved language if exists
                setTimeout(() => {
                    if (currentLanguage !== 'en') {
                        applyTranslation(currentLanguage);
                    }
                }, 1500);
            }
        }

        // Language management
        function initializeLanguage() {
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.lang === currentLanguage) {
                    option.classList.add('active');
                }
            });
        }

        // ENHANCED: Change language function with cross-page sync
        async function changeLanguage(langCode) {
            try {
                console.log('Changing language to:', langCode);
                currentLanguage = langCode;
                localStorage.setItem('selectedLanguage', langCode);

                // Update active language option
                document.querySelectorAll('.language-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.lang === langCode) {
                        option.classList.add('active');
                    }
                });

                showNotification('Changing language for all pages...', 'info');

                if (langCode === 'en') {
                    resetToEnglish();
                    showNotification('Language changed to English on all pages!', 'success');
                    return;
                }

                // Apply translation
                await applyTranslation(langCode);

                const langName = langCode === 'ml' ? 'Malayalam' : 'Hindi';
                showNotification(`Language changed to ${langName} on all pages!`, 'success');

                // Notify other open pages about language change
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'selectedLanguage',
                    newValue: langCode
                }));

            } catch (error) {
                console.error('Translation error:', error);
                showNotification('Failed to change language. Please try again.', 'error');
            }
        }

        // ENHANCED: Apply translation with multiple methods
        async function applyTranslation(targetLang) {
            return new Promise((resolve) => {
                const checkAndTranslate = () => {
                    // Method 1: Direct combo selector
                    const combo = document.querySelector('.goog-te-combo');
                    if (combo) {
                        console.log('Using combo method for translation');
                        combo.value = targetLang;
                        combo.dispatchEvent(new Event('change'));
                        resolve();
                        return;
                    }

                    // Method 2: Frame method
                    const frame = document.querySelector('.goog-te-menu-frame');
                    if (frame && frame.contentDocument) {
                        try {
                            const langLinks = frame.contentDocument.querySelectorAll('.goog-te-menu2-item span.text');
                            for (let link of langLinks) {
                                if ((targetLang === 'ml' && link.textContent.includes('Malayalam')) ||
                                    (targetLang === 'hi' && link.textContent.includes('Hindi'))) {
                                    link.click();
                                    resolve();
                                    return;
                                }
                            }
                        } catch (e) {
                            console.log('Frame method failed, trying cookie method...');
                        }
                    }

                    // Method 3: Cookie method
                    if (!googleTranslateLoaded || checkAndTranslate.attempts > 5) {
                        console.log('Using cookie method for translation');
                        triggerTranslation(targetLang);
                        resolve();
                    } else {
                        // Increment attempts and retry
                        checkAndTranslate.attempts = (checkAndTranslate.attempts || 0) + 1;
                        setTimeout(checkAndTranslate, 500);
                    }
                };

                checkAndTranslate();
            });
        }

        // Enhanced programmatic translation trigger
        function triggerTranslation(targetLang) {
            console.log('Triggering cookie-based translation to:', targetLang);

            // Set translation cookies
            const domain = window.location.hostname;
            document.cookie = `googtrans=/en/${targetLang}; path=/; domain=${domain}`;
            document.cookie = `googtrans=/en/${targetLang}; path=/`;

            // Also try the combo if it becomes available
            const checkCombo = setInterval(() => {
                const combo = document.querySelector('.goog-te-combo');
                if (combo) {
                    combo.value = targetLang;
                    combo.dispatchEvent(new Event('change'));
                    clearInterval(checkCombo);
                }
            }, 100);

            // Clear interval after 5 seconds
            setTimeout(() => clearInterval(checkCombo), 5000);

            // Force page reload if translation doesn't take effect
            setTimeout(() => {
                if (!document.querySelector('html[lang="' + targetLang + '"]')) {
                    window.location.reload();
                }
            }, 3000);
        }

        // Reset to English with cross-page sync
        function resetToEnglish() {
            console.log('Resetting to English on all pages');

            // Clear translation cookies
            const domain = window.location.hostname;
            document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${domain}`;
            document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;

            // Reset Google Translate
            const combo = document.querySelector('.goog-te-combo');
            if (combo) {
                combo.value = '';
                combo.dispatchEvent(new Event('change'));
            }

            // Reload page to ensure clean English
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // Listen for language changes from other pages
        window.addEventListener('storage', function (e) {
            if (e.key === 'selectedLanguage') {
                console.log('Language changed from another page:', e.newValue);
                currentLanguage = e.newValue || 'en';
                initializeLanguage();

                if (e.newValue && e.newValue !== 'en') {
                    setTimeout(() => {
                        applyTranslation(e.newValue);
                    }, 500);
                } else if (e.newValue === 'en') {
                    resetToEnglish();
                }
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            initializeTheme();
            initializeLanguage();
            loadUserProfile();
            setupEventListeners();
            loadUserStats();

            // Apply global language after page load
            setTimeout(() => {
                if (currentLanguage !== 'en') {
                    applyTranslation(currentLanguage);
                }
            }, 2000);
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await fetch(API_BASE_URL + '/api/user/profile', {
                    credentials: 'include'
                });

                if (response.ok) {
                    userProfile = await response.json();
                    populateProfileForm(userProfile);
                } else {
                    console.error('Failed to load profile');
                    showNotification('Failed to load profile data', 'error');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showNotification('Failed to load profile data', 'error');
            }
        }

        // FIXED: Populate profile form with proper image loading
        function populateProfileForm(user) {
            document.getElementById('fullName').value = user.username || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('farmSize').value = user.farmSize || '';
            document.getElementById('location').value = user.location || '';
            document.getElementById('farmDescription').value = user.farmDescription || '';

            // Update profile display
            document.getElementById('profileDisplayName').textContent = user.username || 'Kerala Farmer';

            // FIXED: Set avatar properly - check for saved image first
            const avatarImg = document.getElementById('profileAvatar');
            const avatarText = document.getElementById('profileAvatarText');

            if (user.profileImage && user.profileImage.trim() !== '') {
                // User has a saved profile image
                avatarImg.src = user.profileImage;
                avatarImg.style.display = 'block';
                avatarText.style.display = 'none';
                console.log('‚úÖ Loaded profile image:', user.profileImage);
            } else {
                // No saved image, show initials
                avatarImg.style.display = 'none';
                avatarText.style.display = 'flex';
                avatarText.textContent = (user.username || 'F').charAt(0).toUpperCase();
                console.log('‚úÖ Showing initials for user:', user.username);
            }
        }


        // ENHANCED: Handle avatar upload with immediate save to database
        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (2MB limit)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Image size should be less than 2MB', 'error');
                document.getElementById('avatarInput').value = '';
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file', 'error');
                document.getElementById('avatarInput').value = '';
                return;
            }

            // Show immediate preview
            const reader = new FileReader();
            reader.onload = async function (e) {
                const avatarImg = document.getElementById('profileAvatar');
                const avatarText = document.getElementById('profileAvatarText');

                // Update UI immediately
                avatarImg.src = e.target.result;
                avatarImg.style.display = 'block';
                avatarText.style.display = 'none';

                showNotification('Uploading profile picture...', 'info');

                // IMMEDIATELY save to database
                try {
                    const profileData = {
                        profileImage: e.target.result // Base64 image
                    };

                    const response = await fetch(API_BASE_URL + '/api/user/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(profileData)
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // Update local profile data
                        userProfile = result.user;

                        // Update image src to the saved version
                        if (result.user.profileImage) {
                            avatarImg.src = result.user.profileImage;
                        }

                        showNotification('Profile picture saved successfully!', 'success');
                        console.log('‚úÖ Profile image saved to database');

                    } else {
                        throw new Error('Failed to save profile image');
                    }

                } catch (error) {
                    console.error('Error saving profile image:', error);
                    showNotification('Failed to save profile picture. Please try again.', 'error');

                    // Revert UI on error
                    avatarImg.style.display = 'none';
                    avatarText.style.display = 'flex';
                    avatarText.textContent = (userProfile.username || 'F').charAt(0).toUpperCase();
                }
            };

            reader.onerror = function () {
                showNotification('Error reading image file. Please try again.', 'error');
                document.getElementById('avatarInput').value = '';
            };

            reader.readAsDataURL(file);
        }

        // UPDATED: Handle profile form submission with image
        async function handleProfileSubmit(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('saveProfileBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Saving...</span>';

            try {
                const profileData = {
                    username: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    farmSize: document.getElementById('farmSize').value,
                    location: document.getElementById('location').value,
                    farmDescription: document.getElementById('farmDescription').value
                };

                // Include profile image if one was selected
                if (userProfile.pendingProfileImage) {
                    profileData.profileImage = userProfile.pendingProfileImage;
                }

                const response = await fetch(API_BASE_URL + '/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Profile updated successfully in database!', 'success');
                    userProfile = result.user;
                    delete userProfile.pendingProfileImage; // Clear pending image
                    populateProfileForm(userProfile);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showNotification(error.message || 'Failed to update profile', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i><span>Save Changes</span>';
            }
        }




        // Load user statistics
        async function loadUserStats() {
            try {
                const response = await fetch(API_BASE_URL + '/api/user/stats', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('userPosts').textContent = stats.posts || 0;
                    document.getElementById('userComments').textContent = stats.comments || 0;
                }
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Account deletion feature disabled
        function confirmDeleteAccount() {
            showNotification('Account deletion feature is currently disabled.', 'info');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';

            notification.innerHTML = `
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; margin-left: auto; cursor: pointer; font-size: 1.2rem;">√ó</button>
        `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        console.log('Profile page loaded with enhanced features');
    </script>

    <!-- Hidden Google Translate Element -->
    <div id="google_translate_element" style="display: none;"></div>

    <!-- CSS to hide Google Translate branding -->
    <style>
        .goog-te-banner-frame {
            display: none !important;
        }

        .goog-te-menu-value {
            color: transparent !important;
        }

        .goog-te-gadget {
            color: transparent !important;
        }

        .goog-te-combo {
            display: none !important;
        }

        body {
            top: 0 !important;
        }

        .skiptranslate {
            display: none !important;
        }
    </style>


    <!-- Hidden Google Translate Element -->
    <div id="google_translate_element" style="display: none;"></div>
</body>

</html>